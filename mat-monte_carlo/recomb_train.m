function [TMRCA, adapt]=recomb_train(distribution_s,r,M,s0,L,N,tf,f0,muL,run,exp_name)

global yesgenealogy

%% –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
% distribution_s - –æ–¥–Ω–æ –∏–∑ —á–µ—Ç—ã—Ä–µ—Ö —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –Ω–∏–∂–µ
% r - —á–∞—Å—Ç–æ—Ç–∞ —Ä–µ–∫–æ–º–±–∏–Ω–∞—Ü–∏–π –Ω–∞ –≥–µ–Ω–æ–º
% M - —á–∏—Å–ª–æ –∫—Ä–æ—Å—Å–∏–Ω–≥–æ–≤–µ—Ä–æ–≤
% s0 - —Å—Ä–µ–¥–Ω–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ—Ç–±–æ—Ä–∞
% L - —á–∏—Å–ª–æ –ª–æ–∫—É—Å–æ–≤
% N - —á–∏—Å–ª–µ–Ω–Ω–æ—Å—Ç—å –ø–æ–ø—É–ª—è—Ü–∏–∏
% tf - –ø–æ–ª–Ω–æ–µ –≤—Ä–µ–º—è –≤ –ø–æ–∫–æ–ª–µ–Ω–∏—è—Ö
% f0 - –Ω–∞—á–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ª–ª–µ–ª—è
% muL - —á–∞—Å—Ç–æ—Ç–∞ –º—É—Ç–∞—Ü–∏–π –Ω–∞ –≥–µ–Ω–æ–º
% run - –Ω–æ–º–µ—Ä –∑–∞–ø—É—Å–∫–∞
% exp_name - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∏–º—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π —Ñ–∞–π–ª–æ–≤

%% –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
if ~exist('graphics', 'dir')
    mkdir('graphics');
end

%% –°–ª—É—á–∞–π–Ω—ã–π —Å–∏–¥ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
rng(run)

%% –ß–∞—Å—Ç–æ—Ç–∞ –º—É—Ç–∞—Ü–∏–π –Ω–∞ –ª–æ–∫—É—Å
mu=muL/L;                      % –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ç–∏–ø–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
T= 0:tf;                       % –≤—Ä–µ–º–µ–Ω–∞

%% –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è s –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–ø–∏—Å–µ–π –∫ —Ä–∏—Å. 1 

switch distribution_s
    case 'exponential'
        %  g(s) = (1/s0)*exp(-s/s0)
        s = -s0*log(rand(1,L));
        ts = sprintf('—ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ\n exp(-s/s0)\n N=%g,r=%g,L=%g,s0=%g\n f0=%g, muL=%g, tf=%g, M=%g, run=%g',...
            N,r,L,s0,f0, muL,tf, M, run);
    case 'const'
        s = s0*ones(1,L);
         ts = sprintf('–ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ s\n N=%g,r=%g,L=%g,s0=%g\n f0=%g, muL=%g, tf=%g, M=%g, run=%g',...
            N,r,L,s0,f0, muL,tf, M, run);
    case 'halfgaussian'
        % g(s)=(2/pi/s0)*exp(-s^2/pi/s0^2), s0 avrg
        s = s0*sqrt(pi/2)*abs(randn(1,L));
        ts = sprintf('–ø–æ–ª—É–≥–∞—É—Å—Å–æ–≤–æ\n N=%g,r=%g,L=%g,s0=%g\n f0=%g, muL=%g, tf=%g, M=%g, run=%g',...
            N,r,L,s0,f0, muL,tf, M, run);
end

%% –í–´–ß–ò–°–õ–ï–ù–ò–ï –¢–ï–û–†–ï–¢–ò–ß–ï–°–ö–û–ô –°–ö–û–†–û–°–¢–ò –ê–î–ê–ü–¢–ê–¶–ò–ò
%% –í–´–ß–ò–°–õ–ï–ù–ò–ï –¢–ï–û–†–ï–¢–ò–ß–ï–°–ö–û–ô –°–ö–û–†–û–°–¢–ò –ê–î–ê–ü–¢–ê–¶–ò–ò
V_theory = compute_theoretical_velocity(N, s0, L, f0, muL);

%% –ù–∞—á–∞–ª—å–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

A=(1:N)'*ones(1,L); % –º–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–µ–¥–∫–æ–≤
tint=round(tf/10); % –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
col='rgbmkrgbmkrgbmkrgbmk';
fsample=0.1; % –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–±–æ—Ä–∫–∏ –¥–ª—è –ø–∞—Ä

%% –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–ø—É–ª—è—Ü–∏—è

% –°–ª—É—á–∞–π 1: —Å–ª—É—á–∞–π–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ –∞–ª–ª–µ–ª–∏ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —á–∞—Å—Ç–æ—Ç–æ–π f0
if f0~=0
    K=(rand(N,L) < f0); 
    % –ú–∞—Ç—Ä–∏—Ü–∞ K: –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ - –≥–µ–Ω–æ–º, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å 0 (–≤—Ä–µ–¥–Ω—ã–µ) –∏ 1 (–±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ)
else
    K=zeros(N,L);
end

% –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
W=zeros(N,length(T));  
P1=zeros(N,length(T)); PL=P1; % –ù–∞—á–∞–ª—å–Ω—ã–µ –º–µ—Ç–∫–∏ —Ä–æ–¥–∏—Ç–µ–ª–µ–π –¥–ª—è 3 —Å–∞–π—Ç–æ–≤ –≤–æ –≤—Ä–µ–º–µ–Ω–∏, –¥–ª—è —Ñ–∏–ª–æ–≥–µ–Ω–∏–∏
fsite=zeros(length(T),L);
kav=zeros(1,length(T)); Vark=kav; fsurvive=kav; C=kav; Call=kav; meanW=kav;
Knew=zeros(N,L);  % –±–∏–Ω–∞—Ä–Ω—ã–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –î–ù–ö
Anew=zeros(N,L);  % –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–µ—Ç–æ–∫ –ø—Ä–µ–¥–∫–æ–≤
Pnew=zeros(N,L);  % –º–µ—Ç–∫–∏ —Ä–æ–¥–∏—Ç–µ–ª–µ–π


%% –ù–∞—á–∞–ª–æ —ç–≤–æ–ª—é—Ü–∏–∏...
for t=T
% —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–µ –º—É—Ç–∞—Ü–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
    if mu > 0
        K = xor(K, rand(N,L) < mu); 
    end
   
% –ù–∞—á–∞–ª—å–Ω—ã–µ –º–µ—Ç–∫–∏ —Ä–æ–¥–∏—Ç–µ–ª–µ–π
    P=(1:N)'*ones(1,L); % –º–∞—Ç—Ä–∏—Ü–∞ —Ä–æ–¥–∏—Ç–µ–ª–µ–π
    
%% –°–ª—É—á–∞–π–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞ –ø–æ—Ç–æ–º–∫–æ–≤ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–±–æ—Ä —Å "—Å–ª–æ–º–∞–Ω–Ω–æ–π –ø–∞–ª–∫–æ–π"
% —Å—Ç–æ–ª–±–µ—Ü N –ª–æ–≥–∞—Ä–∏—Ñ–º–æ–≤ –ø—Ä–∏—Å–ø–æ—Å–æ–±–ª–µ–Ω–Ω–æ—Å—Ç–µ–π; —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å 0 –∏–º–µ–µ—Ç w=0 (–ø—Ä–∏—Å–ø–æ—Å–æ–±–ª–µ–Ω–Ω–æ—Å—Ç—å 1) –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é
    w=K*(s'); 
% –¥–æ–±–∞–≤–∏—Ç—å —ç–ø–∏—Å—Ç–∞–∑–∏—Å –∑–¥–µ—Å—å! –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Tij, Eij —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –≤ –Ω–∞—á–∞–ª–µ.
    nprogav=exp(w)/mean(exp(w));    % —Å—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –ø–æ—Ç–æ–º–∫–æ–≤
    b2=cumsum(nprogav);
    b1=[0;b2(1:end-1)];             % —Å–ª–æ–º–∞–Ω–Ω–∞—è –ø–∞–ª–∫–∞
    X=rand(N,1)*N;
    nprog=zeros(N,1);
    for i=1:N
        nprog(i)=sum( X > b1(i) & X < b2(i)); % –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –ø–æ—Ç–æ–º–∫–æ–≤
    end
    %disp(sprintf('size(nprog)=%g ',size(nprog)))
  
%% –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ø—É–ª—è—Ü–∏–∏
    is=[0;cumsum(nprog(1:(N-1)))];
    for i=1:N
        if nprog(i)
            Knew(is(i)+1:is(i)+nprog(i),:)=ones(nprog(i),1)*K(i,:); % –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –î–ù–ö
            Anew(is(i)+1:is(i)+nprog(i),:)=ones(nprog(i),1)*A(i,:); % –º–µ—Ç–∫–∏ –ø—Ä–µ–¥–∫–æ–≤
            Pnew(is(i)+1:is(i)+nprog(i),:)=ones(nprog(i),1)*P(i,:); % –º–µ—Ç–∫–∏ —Ä–æ–¥–∏—Ç–µ–ª–µ–π
        end
    end
    K=Knew;%(X,:);
    A=Anew;%(X,:);
    P=Pnew;%(X,:);
     
   %% –†–µ–∫–æ–º–±–∏–Ω–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–∞—Ä —Å –∑–∞–º–µ–Ω–æ–π –æ–¥–Ω–æ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è
    npairs=round(r*N/2);
    ii=ceil(rand(npairs,2)*N); i1=ii(:,1); i2=ii(:,2);  % 2 —Å—Ç–æ–ª–±—Ü–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ —Ä–æ–¥–∏—Ç–µ–ª–µ–π
    for i=1:npairs
        % –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö 1 –∏–ª–∏ 0 –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∞–π—Ç–∞, —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—è–º–∏ M/L –∏ 1-M/L,
        % —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –∫—Ä–æ—Å—Å–∏–Ω–≥–æ–≤–µ—Ä—ã –µ–¥–∏–Ω–∏—Ü–∞–º–∏
        % –ß–µ—Ç–Ω—ã–µ/–Ω–µ—á–µ—Ç–Ω—ã–µ xx –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å–µ–≥–º–µ–Ω—Ç—ã —Å–∞–π—Ç–æ–≤, —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç 1-–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è, 2-–≥–æ, 1-–≥–æ, 2-–≥–æ –∏ —Ç.–¥.
        xx=cumsum(rand(1,L) < M/L); 
        % —Å–∞–π—Ç—ã, —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç 1-–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è, –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ 1
        first=(round(xx/2)==xx/2);     
        % —Ä–µ–∫–æ–º–±–∏–Ω–∞–Ω—Ç–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –î–ù–ö
        prog1=K(i1(i),:).*first+K(i2(i),:).*(1-first);   
        % —Ä–µ–∫–æ–º–±–∏–Ω–∞–Ω—Ç–Ω–∞—è –º–µ—Ç–∫–∞ –ø—Ä–µ–¥–∫–∞
        prog1A = A(i1(i),:).*first + A(i2(i),:).*(1-first);
        % —Ä–µ–∫–æ–º–±–∏–Ω–∞–Ω—Ç–Ω–∞—è –º–µ—Ç–∫–∞ —Ä–æ–¥–∏—Ç–µ–ª—è
        prog1P = P(i1(i),:).*first + P(i2(i),:).*(1-first);      
%% –ó–∞–º–µ–Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—è
        if rand > 0.5  
            K(i1(i),:)=prog1; % –î–ù–ö 1-–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è –∑–∞–º–µ–Ω–µ–Ω–∞
            A(i1(i),:)=prog1A; % –º–µ—Ç–∫–∞ –ø—Ä–µ–¥–∫–∞ 1-–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è –∑–∞–º–µ–Ω–µ–Ω–∞
            P(i1(i),:)=prog1P; % –º–µ—Ç–∫–∞ –ø—Ä–µ–¥–∫–∞ 1-–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è –∑–∞–º–µ–Ω–µ–Ω–∞
        else
            K(i2(i),:)=prog1; % –î–ù–ö 2-–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è –∑–∞–º–µ–Ω–µ–Ω–∞
            A(i2(i),:)=prog1A; % –º–µ—Ç–∫–∞ –ø—Ä–µ–¥–∫–∞ 2-–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è –∑–∞–º–µ–Ω–µ–Ω–∞
            P(i2(i),:)=prog1P; % –º–µ—Ç–∫–∞ –ø—Ä–µ–¥–∫–∞ 2-–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è –∑–∞–º–µ–Ω–µ–Ω–∞
        end
    end % —Å–ø–∞—Ä–∏–≤–∞–Ω–∏—è  

    
    %% –ó–∞–ø–∏—Å—å –±–∞–∑–æ–≤—ã—Ö –Ω–∞–±–ª—é–¥–∞–µ–º—ã—Ö –≤–µ–ª–∏—á–∏–Ω 
   
    fsite(t+1,:)=mean(K);        % —á–∞—Å—Ç–æ—Ç—ã –∞–ª–ª–µ–ª–µ–π –≤ 1-—Å–∞–π—Ç–µ –≤–æ –≤—Å–µ—Ö —Å–∞–π—Ç–∞—Ö
    kav(t+1)=L*mean(mean(K));     % —Å—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –∞–ª–ª–µ–ª–µ–π –Ω–∞ –≥–µ–Ω–æ–º
    Vark(t+1)=(std(w)/s0)^2;       % –¥–∏—Å–ø–µ—Ä—Å–∏—è —á–∏—Å–ª–∞ –∞–ª–ª–µ–ª–µ–π –º–µ–∂–¥—É –≥–µ–Ω–æ–º–∞–º–∏
    fsurvive(t+1)= mean(~all(K==0));
    % –î–æ–ª—è –ø–∞—Ä –≥–æ–º–æ–ª–æ–≥–∏—á–Ω—ã—Ö –ª–æ–∫—É—Å–æ–≤ —Å –æ–±—â–∏–º –ø—Ä–µ–¥–∫–æ–º
    xx=round(N*fsample);
    i1=ceil(N*rand(1,xx)); i2=ceil(N*rand(1,xx));
    C(t+1)=mean(mean(A(i1,:)==A(i2,:)));
    Call(t+1)= mean(~std(A));
    % –ü—Ä–∏—Å–ø–æ—Å–æ–±–ª–µ–Ω–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –≥–µ–Ω–æ–º–æ–≤
    W(:,t+1) = w;
    meanW(t+1)=mean(w);

    %% –∑–∞–ø–æ–º–Ω–∏—Ç—å –∏–º–µ–Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª–µ–π –¥–ª—è 1-–≥–æ –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ª–æ–∫—É—Å–æ–≤   
    P1(:,t+1)=P(:,1); PL(:,t+1)=P(:,L);    
    
    %% –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –≤–æ–ª–Ω—ã –∏ —Å–ø–µ–∫—Ç—Ä–∞ ancestral clone –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –º–æ–º–µ–Ω—Ç—ã –≤—Ä–µ–º–µ–Ω–∏
    if tint*round(t/tint)==t 
        c=col(round(t/tint)+1);
        figure(1)
        subplot(2,2,1)
        [nn,xx]=hist(w);         % –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –ø—Ä–∏—Å–ø–æ—Å–æ–±–ª–µ–Ω–Ω–æ—Å—Ç–∏ —Å—Ä–µ–¥–∏ –≥–µ–Ω–æ–º–æ–≤
        semilogy(xx/s0,nn,c)
        hold on
        text(xx(end)/s0,nn(end),sprintf('%g',t))
    end % if sampling time

end % —Ü–∏–∫–ª –ø–æ –≤—Ä–µ–º–µ–Ω–∏

% –≠–≤–æ–ª—é—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞

%% –§–∏–Ω–∞–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏
figure(1) % –ë–µ–≥—É—â–∞—è –≤–æ–ª–Ω–∞
subplot(2,2,1)
hold off
xlabel('–ß–∏—Å–ª–æ –∞–ª–ª–µ–ª–µ–π, k');
ylabel('–§—É–Ω–∫—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è')
title(ts)   % –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
 
%% –°—Ä–µ–¥–Ω–∏–µ –Ω–∞–±–ª—é–¥–∞–µ–º—ã–µ –≤–µ–ª–∏—á–∏–Ω—ã vs –≤—Ä–µ–º—è

kav=reshape(kav, size(T)); % —Å—Ä–µ–¥–Ω–µ–µ k
Vark=reshape(Vark, size(T)); % –î–∏—Å–ø–µ—Ä—Å–∏—è k
dist=mean(L*2*fsite.*(1-fsite),2);
dist=reshape(dist,size(T));
% –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
V=(kav(4:end)-kav(1:(end-3)))/3; 
V=[V(1:3),V];

% 1-—Å–∞–π—Ç–æ–≤–∞—è —Ç–µ–æ—Ä–∏—è
f1site=f0*(f0+(1-f0)*exp(-s0*T)).^(-1); 

%%
subplot(2,2,2)
plot(T,kav/L,'r',T,sqrt(Vark)/L,'b',T,dist/L,'g',T,C,'--k',...
    T,fsurvive,'k',T,Call,'m',T,f1site,':');

% –ú–û–î–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–´–ô –ó–ê–ì–û–õ–û–í–û–ö –° –¢–ï–û–†–ï–¢–ò–ß–ï–°–ö–û–ô –°–ö–û–†–û–°–¢–¨–Æ
if ~isnan(V_theory)
    title(sprintf('–¢–µ–æ—Ä. —Å–∫–æ—Ä–æ—Å—Ç—å: V=%.3e\n k_{—Å—Ä}/L –∫—Ä SD_k/L —Å–∏–Ω, dist/L –∑–µ–ª \n C --—á–µ—Ä, f_{–≤—ã–∂} —á–µ—Ä, Call –ø—É—Ä–ø', V_theory));
else
    title(sprintf('k_{—Å—Ä}/L –∫—Ä SD_k/L —Å–∏–Ω, dist/L –∑–µ–ª \n C --—á–µ—Ä, f_{–≤—ã–∂} —á–µ—Ä, Call –ø—É—Ä–ø'));
end

xlabel('–í—Ä–µ–º—è, t');
axis([0 T(end) 0 1])
Cinf=fsurvive(end);

subplot(2,2,3)
meanf_end=mean(fsite(end,:));
for i=1:L
    plot(T',fsite(:,i),T,f1site,'k--')
    hold on
end
hold off
ylabel('–ß–∞—Å—Ç–æ—Ç–∞ –∞–ª–ª–µ–ª—è –≤–æ –≤—Å–µ—Ö –ª–æ–∫—É—Å–∞—Ö')
xlabel ('–í—Ä–µ–º—è, t')
title(sprintf('—Å—Ä–µ–¥–Ω(f_{–∫–æ–Ω}) = %g',meanf_end))

subplot(2,2,4)
for t=0:tint:tf
    [nn,xx]=hist(fsite(t+1,:));
     text(xx(end),nn(end),sprintf('t=%g',t))
    plot(xx,nn)
    hold on
end
ylabel('–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω')
xlabel ('–ß–∞—Å—Ç–æ—Ç–∞ –∞–ª–ª–µ–ª—è –≤ –ª–æ–∫—É—Å–µ, t')
hold off

%% –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Figure 1
filename1 = sprintf('graphics/%s_fig1_run%d_N%d_L%d_s0%.3f_r%.3f', ...
    exp_name, run, N, L, s0, r);
saveas(gcf, [filename1, '.png']);
%saveas(gcf, [filename1, '.fig']);

if yesgenealogy
    %% –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è –≥–µ–Ω–µ–∞–ª–æ–≥–∏–∏
    figure(2)
    % –í—ã–±–æ—Ä–∫–∞ –≥–µ–Ω–æ–º–æ–≤ –≤ t=tf
    ii=[1 N/4:N/4:N];
    % –ù–æ–º–µ—Ä–∞ –≥–µ–Ω–µ–∞–ª–æ–≥–∏–∏ –ª–æ–∫—É—Å—ã 1 –∏ 2 
    G1(tf+1,ii) = ii; 
    GL(tf+1,ii) = ii;
    for t = tf:-1:1
        G1(t,ii) = P1(G1(t+1,ii),t+1);
        GL(t,ii) = PL(GL(t+1,ii),t+1);
    end
    subplot(2,2,1)
    plot(T,G1(:,ii)); 
    title(ts)
    ylabel('–†–æ–¥–∏—Ç–µ–ª—å, –ª–æ–∫—É—Å 1')

    %% –í—ã—á–∏—Å–ª–µ–Ω–∏–µ TMRCA 
    TMRCA= tf - max(find(~std(G1(:,ii)')));
    
    subplot(2,2,3)
    plot(T,GL(:,ii)); 
    xlabel('–í—Ä–µ–º—è')
    ylabel('–†–æ–¥–∏—Ç–µ–ª—å, –ª–æ–∫—É—Å L')

    %% –°–∫–æ—Ä–æ—Å—Ç—å –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3/4 –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
    t1=round(tf/4+1); 
    adapt=(meanW(tf+1) - meanW(t1))/(tf-t1);

    %% –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–∏—Å–ø–æ—Å–æ–±–ª–µ–Ω–Ω–æ—Å—Ç–∏
    for t = T
        w1(t+1,ii)=W(G1(t+1,ii),t+1);
        wL(t+1,ii)=W(GL(t+1,ii),t+1);
    end
    subplot(2,2,2)
    plot(T,w1)
    xlabel('–í—Ä–µ–º—è')
    ylabel('–ü—Ä–∏—Å–ø–æ—Å–æ–±–ª–µ–Ω–Ω–æ—Å—Ç—å')
    subplot(2,2,4)
    plot(T,wL)
    xlabel('–í—Ä–µ–º—è')
    ylabel('–ü—Ä–∏—Å–ø–æ—Å–æ–±–ª–µ–Ω–Ω–æ—Å—Ç—å')
    
    %% –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Figure 2
    filename2 = sprintf('graphics/%s_fig2_run%d_N%d_L%d_s0%.3f_r%.3f', ...
        exp_name, run, N, L, s0, r);
    saveas(gcf, [filename2, '.png']);
   % saveas(gcf, [filename2, '.fig']);

    %% –§–∏–ª–æ–≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–æ–µ –¥–µ—Ä–µ–≤–æ
    figure(3)
    m=length(ii);
    yesconnect1=ones(size(ii)); % –º–µ—Ç–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è
    yesconnectL=ones(size(ii)); % –º–µ—Ç–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è
    color='rbmkrbmkrbmk'; % —Ü–≤–µ—Ç–∞ –ª–∏–Ω–∏–π

    % –¶–∏–∫–ª –Ω–∞–∑–∞–¥ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ 
    for t=tf:-1:0
        % –¥–µ—Ä–µ–≤–æ –ø–µ—Ä–≤–æ–≥–æ —Å–∞–π—Ç–∞
        subplot(2,1,1)
        for i=1:m 
            % –Ω–∞–π—Ç–∏ –≤—Å–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è > i
            jj=find(G1(t+1,ii(i))==G1(t+1,ii((i+1):m)));
            if isempty(jj) && yesconnect1(i)
                % –µ—Å–ª–∏ –Ω–µ—Ç, –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç
                plot ([t t+1],[i i],color(i)); hold on 
            elseif yesconnect1(i)
                % –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞–∫–ª–æ–Ω–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç –≤–≤–µ—Ä—Ö
                plot ([t t+1],[max(jj)+i, i],color(i)); hold on 
                % –∏ –±–æ–ª—å—à–µ –Ω–µ —Å—Ç—Ä–æ–∏—Ç—å –µ–≥–æ
                yesconnect1(i)=0;  
            end 
        end % –ø–æ –ª–∏–Ω–∏—è–º
        
        % –¥–µ—Ä–µ–≤–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∞–π—Ç–∞
        subplot(2,1,2)
        for i=1:m 
            % –Ω–∞–π—Ç–∏ –≤—Å–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è > i
            jj=find(GL(t+1,ii(i))==GL(t+1,ii((i+1):m)));
            if isempty(jj) && yesconnectL(i)
                % –µ—Å–ª–∏ –Ω–µ—Ç, –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç
                plot ([t t+1],[i i],color(i)); hold on 
            elseif yesconnectL(i)
                % –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞–∫–ª–æ–Ω–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç –≤–≤–µ—Ä—Ö
                plot ([t t+1],[max(jj)+i, i],color(i)); hold on 
                % –∏ –±–æ–ª—å—à–µ –Ω–µ —Å—Ç—Ä–æ–∏—Ç—å –µ–≥–æ
                yesconnectL(i)=0;  
            end 
        end % –ø–æ –ª–∏–Ω–∏—è–º
    end  % –ø–æ –≤—Ä–µ–º–µ–Ω–∏

    subplot(2,1,1)
    hold off
    ylabel('–î–µ—Ä–µ–≤–æ, –ª–æ–∫—É—Å 1')
    xlabel('–í—Ä–µ–º—è')
    title(ts)
    axis([0 tf+1 0.5 m+0.5])
    subplot(2,1,2)
    hold off
    ylabel('–î–µ—Ä–µ–≤–æ, –ª–æ–∫—É—Å L')
    xlabel('–í—Ä–µ–º—è')
    title(ts)
    axis([0 tf+1 0.5 m+0.5])
    
    %% –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Figure 3
    filename3 = sprintf('graphics/%s_fig3_run%d_N%d_L%d_s0%.3f_r%.3f', ...
        exp_name, run, N, L, s0, r);
    saveas(gcf, [filename3, '.png']);
    %saveas(gcf, [filename3, '.fig']);
    
end % yesgenealogy?

% –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫: —ç–≤–æ–ª—é—Ü–∏—è —Å—Ä–µ–¥–Ω–µ–π –ø—Ä–∏—Å–ø–æ—Å–æ–±–ª–µ–Ω–Ω–æ—Å—Ç–∏
figure(4)
plot(T, meanW)
xlabel('–í—Ä–µ–º—è, t')
ylabel('–°—Ä–µ–¥–Ω—è—è –ø—Ä–∏—Å–ø–æ—Å–æ–±–ª–µ–Ω–Ω–æ—Å—Ç—å')
title(sprintf('–≠–≤–æ–ª—é—Ü–∏—è —Å—Ä–µ–¥–Ω–µ–π –ø—Ä–∏—Å–ø–æ—Å–æ–±–ª–µ–Ω–Ω–æ—Å—Ç–∏\n%s', ts))
grid on

%% –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Figure 4
filename4 = sprintf('graphics/%s_fig4_run%d_N%d_L%d_s0%.3f_r%.3f', ...
    exp_name, run, N, L, s0, r);
saveas(gcf, [filename4, '.png']);
%saveas(gcf, [filename4, '.fig']);

% –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
% close all;

fprintf('–ì—Ä–∞—Ñ–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–ø–∫—É graphics —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º: %s\n', exp_name);

end

%% –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –í–´–ß–ò–°–õ–ï–ù–ò–Ø –¢–ï–û–†–ï–¢–ò–ß–ï–°–ö–û–ô –°–ö–û–†–û–°–¢–ò
function V = compute_theoretical_velocity(N, s, L, f0, muL)
    % –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –ø–æ –Ω–æ–≤–æ–π —Ñ–æ—Ä–º—É–ª–µ
    % V ‚âà 2ùë† log(ùëÅ‚àö(ùë†ùëàùëè)) / [log(ùë†/ùëàùëè * log(ùëÅ‚àö(ùë†ùëàùëè)))]^2
    
    % –ß–∞—Å—Ç–æ—Ç–∞ –ø–æ–ª–µ–∑–Ω—ã—Ö –º—É—Ç–∞—Ü–∏–π –Ω–∞ –≥–µ–Ω–æ–º
    Ub = muL * (1 - f0);
    
    % –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
    if Ub <= 0 || s <= 0
        V = 0;
        return;
    end
    
    % –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—É–ª—ã
    N_sqrt_sUb = N * sqrt(s * Ub);
    
    % –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ª–æ–≥–∞—Ä–∏—Ñ–º–æ–≤
    if N_sqrt_sUb <= 1
        V = 0;
        return;
    end
    
    log_N_sqrt_sUb = log(N_sqrt_sUb);
    
    % –í—Ç–æ—Ä–æ–π –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∏–π —á–ª–µ–Ω –≤ –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª–µ
    s_Ub_ratio = s / Ub;
    arg_log2 = s_Ub_ratio * log_N_sqrt_sUb;
    
    if arg_log2 <= 1
        V = 0;
        return;
    end
    
    log_arg_log2 = log(arg_log2);
    
    % –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø–æ —Ñ–æ—Ä–º—É–ª–µ
    numerator = 2 * s * log_N_sqrt_sUb;
    denominator = log_arg_log2^2;
    
    V = numerator / denominator;
    
    % –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–∏–∑–∏—á–Ω–æ—Å—Ç—å
    if V < 0 || V > s * L
        V = 0;
    end
end